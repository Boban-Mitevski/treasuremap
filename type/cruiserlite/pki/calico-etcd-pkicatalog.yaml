---
schema: promenade/PKICatalog/v1
metadata:
  schema: metadata/Document/v1
  name: calico-etcd
  labels:
    name: calico-etcd-type
  layeringDefinition:
    abstract: false
    layer: type
  substitutions:
    # Service IP substitutions
    - src:
        schema: pegleg/CommonAddresses/v1
        name: common-addresses
        path: .calico.etcd.service_ip
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[0].hosts[2]
        - path: .certificate_authorities.calico-etcd.certificates[1].hosts[2]
        - path: .certificate_authorities.calico-etcd.certificates[2].hosts[2]

    # Substitutions for master 0
    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[0].hostname
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[0].common_name
          pattern: HOSTNAME
        - path: .certificate_authorities.calico-etcd.certificates[0].hosts[3]

        - path: .certificate_authorities.calico-etcd-peer.certificates[0].common_name
          pattern: HOSTNAME
        - path: .certificate_authorities.calico-etcd-peer.certificates[0].hosts[2]

    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[0].ip.oam
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[0].hosts[4]
        - path: .certificate_authorities.calico-etcd-peer.certificates[0].hosts[3]

    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[0].ip.ksn
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[0].hosts[5]
        - path: .certificate_authorities.calico-etcd-peer.certificates[0].hosts[4]

    # Substitutions for master 1
    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[1].hostname
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[1].common_name
          pattern: HOSTNAME
        - path: .certificate_authorities.calico-etcd.certificates[1].hosts[3]

        - path: .certificate_authorities.calico-etcd-peer.certificates[1].common_name
          pattern: HOSTNAME
        - path: .certificate_authorities.calico-etcd-peer.certificates[1].hosts[2]

    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[1].ip.oam
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[1].hosts[4]
        - path: .certificate_authorities.calico-etcd-peer.certificates[1].hosts[3]

    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[1].ip.ksn
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[1].hosts[5]
        - path: .certificate_authorities.calico-etcd-peer.certificates[1].hosts[4]

    # Substitutions for master 2
    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[2].hostname
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[2].common_name
          pattern: HOSTNAME
        - path: .certificate_authorities.calico-etcd.certificates[2].hosts[3]

        - path: .certificate_authorities.calico-etcd-peer.certificates[2].common_name
          pattern: HOSTNAME
        - path: .certificate_authorities.calico-etcd-peer.certificates[2].hosts[2]

    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[2].ip.oam
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[2].hosts[4]
        - path: .certificate_authorities.calico-etcd-peer.certificates[2].hosts[3]

    - src:
        schema: nc/ControlPlaneAddresses/v1
        name: control-plane-addresses
        path: .masters[2].ip.ksn
      dest:
        - path: .certificate_authorities.calico-etcd.certificates[2].hosts[5]
        - path: .certificate_authorities.calico-etcd-peer.certificates[2].hosts[4]

  storagePolicy: cleartext
data:
  certificate_authorities:
    calico-etcd:
      description: Certificates for Kubernetes's etcd servers
      certificates:
        - document_name: calico-etcd-master-0
          common_name: calico-etcd-HOSTNAME
          hosts:
            - 127.0.0.1
            - localhost
            # NOTE(mb874d): These are stubs and get replaced via substitution
            - CALICO_ETCD_SERVICE_IP
            - HOSTNAME
            - OAM_IP
            - KSN_IP
          kubernetes_service_names:
            - calico-etcd.kube-system.svc.cluster.local

        - document_name: calico-etcd-master-1
          common_name: calico-etcd-HOSTNAME
          hosts:
            - 127.0.0.1
            - localhost
            # NOTE(mb874d): These are stubs and get replaced via substitution
            - CALICO_ETCD_SERVICE_IP
            - HOSTNAME
            - OAM_IP
            - KSN_IP
          kubernetes_service_names:
            - calico-etcd.kube-system.svc.cluster.local

        - document_name: calico-etcd-master-2
          common_name: calico-etcd-HOSTNAME
          hosts:
            - 127.0.0.1
            - localhost
            # NOTE(mb874d): These are stubs and get replaced via substitution
            - CALICO_ETCD_SERVICE_IP
            - HOSTNAME
            - OAM_IP
            - KSN_IP
          kubernetes_service_names:
            - calico-etcd.kube-system.svc.cluster.local

        - document_name: calico-etcd-anchor
          common_name: anchor
        - document_name: calico-node
          common_name: calico-node

    calico-etcd-peer:
      certificates:
        - document_name: calico-etcd-master-0-peer
          common_name: calico-etcd-HOSTNAME-peer
          hosts:
            - 127.0.0.1
            - localhost
            # NOTE(mb874d): These are stubs and get replaced via substitution
            - HOSTNAME
            - OAM_IP
            - KSN_IP

        - document_name: calico-etcd-master-1-peer
          common_name: calico-etcd-HOSTNAME-peer
          hosts:
            - 127.0.0.1
            - localhost
            # NOTE(mb874d): These are stubs and get replaced via substitution
            - HOSTNAME
            - OAM_IP
            - KSN_IP

        - document_name: calico-etcd-master-2-peer
          common_name: calico-etcd-HOSTNAME-peer
          hosts:
            - 127.0.0.1
            - localhost
            # NOTE(mb874d): These are stubs and get replaced via substitution
            - HOSTNAME
            - OAM_IP
            - KSN_IP
...
