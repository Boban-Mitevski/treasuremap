---
# This file defines a boot action which is responsible for fetching the node's
# promjoin script from the promenade API. This is the script responsible for
# installing kubernetes on the node and joining the kubernetes cluster.
schema: 'drydock/BootAction/v1'
metadata:
  schema: 'metadata/Document/v1'
  name: promjoin-compute
  storagePolicy: 'cleartext'
  layeringDefinition:
    abstract: false
    layer: type
  labels:
    name: promjoin-compute
    application: 'drydock'
data:
  signaling: false
  node_filter:
    filter_set_type: 'union'
    filter_set:
      - filter_type: 'union'
        node_labels:
          # execute boot action on compute nodes
          openstack-nova-compute: enabled
  assets:
    - path: /opt/promjoin.sh
      type: file
      permissions: '555'
      # The ip= parameter must match the MaaS network name of the network used
      # to contact kubernetes. With a standard, reference NC deployment where
      # L2 networks are shared between all racks, the network name (i.e. calico)
      # should be correct.
      location: promenade+http://promenade-api.ucp.svc.cluster.local/api/v1.0/join-scripts?design_ref={{ action.design_ref | urlencode }}&hostname={{ node.hostname }}&ip={{ node.network.calico.ip }}&external_ip={{ node.network.oam.ip }}&domain={{ node.domain }}{% for k, v in node.labels.items() %}&labels.dynamic={{ k }}={{ v }}{% endfor %}
      location_pipeline:
        - template
      data_pipeline:
        - utf8_decode
...
